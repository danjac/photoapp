{% extends "layout.jinja2" %}
{% import "_forms.jinja2" as forms with context %}
{% import "_pagination.jinja2" as pagination with context %}

{% block content %}

<h1>Your own private photos</h1>

{% if request.user %}

<div id="photo-modal" class="modal hide fade"></div>

<script type="text/template" id="photo-modal-template">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3><%= title %></h3>
    </div>
    <div class="modal-body">
        <p>
            <div class="photo-load-progress progress progress-striped active"><div class="bar" style="width:0%;"></div></div> 
            <img class="photo-image hide" src="<%= image_url %>" height="<%= height %>" width="<%= width %>" alt="<%= title %>">
        </p>
    </div>
    <div class="modal-footer">
        <a href="<%= send_url %>" class="btn">Send this photo</a>
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</script>

<ul class="thumbnails">
{% for photo in page.items %}
    <li class="span4">
        <a data-send-url="{{ request.route_url('send', id=photo.id) }}" 
           data-image-url="{{ request.route_url('image', id=photo.id) }}"
           data-width="{{ photo.width }}"
           data-height="{{ photo.height }}"
           data-title="{{ photo.title }}"
           href="#" class="thumbnail">
            <img src="{{ request.route_url('thumbnail', id=photo.id) }}" title="{{ photo.title }}" alt="{{ photo.title }}">
        </a>
    </li>
{% endfor %}
</ul>

{{ pagination.render_page_links(page) }}

{% else %}
{% call forms.render_form(login_form, action=request.route_url('login')) %}
    <legend>Sign in to get started</legend>

    {{ forms.render_field(login_form.email) }}
    {{ forms.render_field(login_form.password) }}

    {{ login_form.login(class="btn") }}

{% endcall %}

<ul class="nav nav-pills">

    <li class="disabled"><a href="#">Sign in</a></li>
    <li><a href="{{ request.route_url('forgot_pass') }}">Forgot your password?</a></li>
    <li><a href="#">Need an invite?</a></li>

</ul>
{% endif %}


{% endblock %}

{% block scripts %}
<script>
    $(function(){

        var modal = $('#photo-modal');
        var tmpl = $('#photo-modal-template').html();

        $('.thumbnails a').on('click', function(){

            var el = $(this);
            var imageURL = el.attr('data-image-url');
            var sendURL = el.attr('data-send-url');
            var title = el.attr('data-title');
            var height = el.attr('data-height');
            var width = el.attr('data-width');

            var content = _.template(tmpl, {
                image_url : imageURL,
                send_url : el.attr('data-send-url'),
                title: el.attr('data-title'),
                height: el.attr('data-height'),
                width: el.attr('data-width')
            });

            modal.on('show', function(){
                var image = new Image();
                image.src = imageURL;
                $(this).html(content);
                var progressBar = $('#photo-modal .photo-load-progress .bar');
                var width = 0;

                var progress = setInterval(function() {
                    if (width < 100){
                        width += 15;
                        progressBar.width(width + "%");
                    }
                });

                image.onload = function(){
                    clearInterval(progress);
                    $('#photo-modal .photo-image').show();
                    $('#photo-modal .photo-load-progress').hide();
                }
           
            }).modal('show');
        });
    });
</script>


{% endblock %}
